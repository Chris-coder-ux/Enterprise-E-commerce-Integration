/**
 * Dashboard Principal - Punto de Entrada
 * 
 * Este archivo orquesta todos los m√≥dulos del dashboard.
 * Mantiene la compatibilidad con el c√≥digo existente mientras
 * organiza la inicializaci√≥n de forma modular.
 * 
 * @file dashboard.js
 * @since 1.0.0
 * @author Christian
 */

/* global jQuery, miIntegracionApiDashboard */

// ========================================
// IMPORTS (Ajustar seg√∫n sistema de m√≥dulos usado)
// ========================================

// Si usas ES6 modules:
// import { ErrorHandler } from './core/ErrorHandler.js';
// import { AjaxManager } from './core/AjaxManager.js';
// import { PollingManager } from './managers/PollingManager.js';
// ... etc

// Si usas CommonJS:
// const { ErrorHandler } = require('./core/ErrorHandler');
// const { AjaxManager } = require('./core/AjaxManager');
// ... etc

// Si usas script tags (actual):
// Los m√≥dulos se cargan antes de este archivo
// y exponen sus clases/funciones globalmente

// ========================================
// VERIFICACI√ìN DE DEPENDENCIAS
// ========================================

(function() {
  'use strict';

  // Verificar jQuery
  if (typeof jQuery === 'undefined') {
    console.error('jQuery no est√° disponible. El dashboard no funcionar√°.');
    return;
  }

  // Verificar configuraci√≥n
  if (typeof miIntegracionApiDashboard === 'undefined') {
    console.error('miIntegracionApiDashboard no est√° definido. El dashboard no funcionar√°.');
    return;
  }

  // ========================================
  // INICIALIZACI√ìN PRINCIPAL
  // ========================================

  jQuery(document).ready(function($) {
    console.log('üöÄ Inicializando Dashboard...');

    // 1. Inicializar sistemas base (core)
    initializeCoreSystems();

    // 2. Inicializar managers
    initializeManagers();

    // 3. Inicializar componentes UI
    initializeUIComponents();

    // 4. Inicializar sistema de sincronizaci√≥n
    initializeSyncSystem();

    // 5. Inicializar dashboards
    initializeDashboards();

    // 6. Inicializar controlador principal
    initializeMainController();

    // 7. Configurar eventos globales
    setupGlobalEvents();

    console.log('‚úÖ Dashboard inicializado correctamente');
  });

  // ========================================
  // FUNCIONES DE INICIALIZACI√ìN
  // ========================================

  /**
   * Inicializar sistemas core
   */
  function initializeCoreSystems() {
    console.log('üîß Inicializando sistemas core...');

    // ErrorHandler ya est√° disponible globalmente
    if (typeof ErrorHandler !== 'undefined') {
      window.ErrorHandler = ErrorHandler;
      console.log('  ‚úÖ ErrorHandler inicializado');
    }

    // AjaxManager ya est√° disponible globalmente
    if (typeof AjaxManager !== 'undefined') {
      window.AjaxManager = AjaxManager;
      console.log('  ‚úÖ AjaxManager inicializado');
    }

    // SystemEventManager
    if (typeof SystemEventManager !== 'undefined') {
      SystemEventManager.init();
      SystemEventManager.emitErrorHandlerReady();
      console.log('  ‚úÖ SystemEventManager inicializado');
    }
  }

  /**
   * Inicializar managers
   */
  function initializeManagers() {
    console.log('üìä Inicializando managers...');

    // PollingManager
    if (typeof PollingManager !== 'undefined') {
      window.pollingManager = new PollingManager();
      console.log('  ‚úÖ PollingManager inicializado');
    }

    // SyncStateManager
    if (typeof SyncStateManager !== 'undefined') {
      SyncStateManager.cleanupOnPageLoad();
      console.log('  ‚úÖ SyncStateManager inicializado');
    }

    // NonceManager
    if (typeof NonceManager !== 'undefined') {
      NonceManager.setupAutoRenewal();
      console.log('  ‚úÖ NonceManager inicializado');
    }
  }

  /**
   * Inicializar componentes UI
   */
  function initializeUIComponents() {
    console.log('üé® Inicializando componentes UI...');

    // ToastManager
    if (typeof ToastManager !== 'undefined') {
      window.showToast = ToastManager.show;
      console.log('  ‚úÖ ToastManager inicializado');
    }

    // ProgressBar
    if (typeof ProgressBar !== 'undefined') {
      ProgressBar.initialize();
      console.log('  ‚úÖ ProgressBar inicializado');
    }

    // ConsoleManager
    if (typeof ConsoleManager !== 'undefined') {
      ConsoleManager.initialize();
      console.log('  ‚úÖ ConsoleManager inicializado');
    }

    // ResponsiveLayout
    if (typeof ResponsiveLayout !== 'undefined') {
      ResponsiveLayout.init();
      console.log('  ‚úÖ ResponsiveLayout inicializado');
    }

    // CardManager
    if (typeof CardManager !== 'undefined') {
      CardManager.initialize();
      console.log('  ‚úÖ CardManager inicializado');
    }
  }

  /**
   * Inicializar sistema de sincronizaci√≥n
   */
  function initializeSyncSystem() {
    console.log('üîÑ Inicializando sistema de sincronizaci√≥n...');

    // SyncProgress
    if (typeof SyncProgress !== 'undefined') {
      window.checkSyncProgress = SyncProgress.check;
      console.log('  ‚úÖ SyncProgress inicializado');
    }

    // Phase1Manager
    if (typeof Phase1Manager !== 'undefined') {
      window.phase1Manager = new Phase1Manager();
      console.log('  ‚úÖ Phase1Manager inicializado');
    }

    // Phase2Manager
    if (typeof Phase2Manager !== 'undefined') {
      window.phase2Manager = new Phase2Manager();
      console.log('  ‚úÖ Phase2Manager inicializado');
    }

    // SyncController
    if (typeof SyncController !== 'undefined') {
      SyncController.initialize();
      console.log('  ‚úÖ SyncController inicializado');
    }
  }

  /**
   * Inicializar dashboards
   */
  function initializeDashboards() {
    console.log('üìä Inicializando dashboards...');

    // SyncDashboard
    if (typeof SyncDashboard !== 'undefined' && jQuery('#sync-two-phase-dashboard').length) {
      window.syncDashboard = new SyncDashboard();
      console.log('  ‚úÖ SyncDashboard inicializado');
    }

    // UnifiedDashboard
    if (typeof UnifiedDashboard !== 'undefined') {
      UnifiedDashboard.init();
      SystemEventManager.emitUnifiedDashboardReady();
      console.log('  ‚úÖ UnifiedDashboard inicializado');
    }
  }

  /**
   * Inicializar controlador principal
   */
  function initializeMainController() {
    console.log('üéØ Inicializando controlador principal...');

    if (typeof UnifiedDashboardController !== 'undefined') {
      UnifiedDashboardController.init();
      console.log('  ‚úÖ UnifiedDashboardController inicializado');
    }
  }

  /**
   * Configurar eventos globales
   */
  function setupGlobalEvents() {
    console.log('‚öôÔ∏è Configurando eventos globales...');

    // Eventos de teclado
    jQuery(document).on('keydown', function(e) {
      // Ctrl + Enter para sincronizar
      if (e.ctrlKey && e.keyCode === 13) {
        const $syncBtn = jQuery('#mi-batch-sync-products');
        if ($syncBtn.length && !$syncBtn.is(':disabled')) {
          $syncBtn.trigger('click');
          if (typeof showToast === 'function') {
            showToast('Atajo de teclado: Ctrl+Enter para sincronizar', 'info', 3000);
          }
        }
      }

      // Escape para cancelar
      if (e.keyCode === 27) {
        const $cancelBtn = jQuery('#mi-cancel-sync');
        if ($cancelBtn.length && $cancelBtn.is(':visible') && !$cancelBtn.is(':disabled')) {
          $cancelBtn.trigger('click');
        }
      }
    });

    // Eventos de conexi√≥n
    window.addEventListener('online', function() {
      if (typeof showToast === 'function') {
        showToast('Conexi√≥n restaurada', 'success', 3000);
      }
    });

    window.addEventListener('offline', function() {
      if (typeof showToast === 'function') {
        showToast('Sin conexi√≥n a internet', 'warning', 5000);
      }
    });

    console.log('  ‚úÖ Eventos globales configurados');
  }

  // ========================================
  // EXPORTS (si usas m√≥dulos)
  // ========================================

  // Si usas ES6 modules:
  // export default { initializeCoreSystems, initializeManagers, ... };

  // Si usas CommonJS:
  // module.exports = { initializeCoreSystems, initializeManagers, ... };

  // Si usas script tags, las funciones ya est√°n disponibles globalmente

})();

